---
title: "Aggregation Data-FtUnion"
author: "Bruce Wang"
date: "11/15/2019"
output: html_document
editor_options: 
  chunk_output_type: console
---

## Loading Libraries
```{r Loading Libraries}
## Load Libraries
library(tidyverse)
library(readxl)
library(lubridate)
library(ggplot2)
```

## Creating an Analysis Dataset
This scripte is to analyze the group of signals on FtUnion corridor 
There are total 10 signals and 20 approaches included on the FtUnion corrdior
```{r Signal Performance Measures Dataset}
# Safety aggregation table: Red Light Actuation
RA_FtUnion <-read_xls("ATSPM/data/FtUnion/FtUnion_RedActuation.xls") %>%
  mutate(
    BinStartTime = as_datetime(BinStartTime),
    SignalId = as.numeric(SignalId)
  )

# Purdue Coordination Diagram aggregation table: ArrivalOnGreen, ArrivalOnRed, and Platoon Ratio
PCD_FtUnion <-read_xls("ATSPM/data/FtUnion/FtUnion_PCD.xls") %>% 
  mutate(
    BinStartTime = as_datetime(BinStartTime),
    SignalId = as.numeric(SignalId),
    TotalVolume = as.numeric(TotalVolume),
    PlatoonRatio = as.numeric(PlatoonRatio)
  )
    
# Split Failure aggregation table: Split Failures
SF_FtUnion <-read_xls("ATSPM/data/FtUnion/FtUnion_SplitFail.xls") %>% 
  mutate(
    BinStartTime = as_datetime(BinStartTime),
    SignalId = as.numeric(SignalId)
  )  

# Purdue Phase Termination Diagram aggregation table: Max out, Gap out, and Force Off
PPT_FtUnion <-read_xls("ATSPM/data/FtUnion/FtUnion_PPT.xls") %>% 
  mutate(
    BinStartTime = as_datetime(BinStartTime),
    SignalId = as.numeric(SignalId)
  )

# Number of Cycles for FtUnion: Cycles Number 
Cyc_FtUnion <-read_xls("ATSPM/data/FtUnion/FtUnion_Cycles.xls") %>%
  mutate(
    BinStartTime = as_datetime(BinStartTime),
    SignalId = as.numeric(SignalId)
  )

```

## Combine Aggregation Tables using Left Join command
```{r Combine Dataset}
# Create a Base Table: BinStartTime, SignalID, and ApproachID
BaseTable_FtUnion <-read_xls("ATSPM/data/FtUnion/FtUnion_BaseTable.xls") %>%
  mutate(
    BinStartTime = as_datetime(BinStartTime),
    SignalId = as.numeric(SignalId),
    ApproachId = as.numeric(ApproachId),
  )

# Join all the aggregation tables into a signle analysis dataset
df1_FtUnion <- left_join(
  BaseTable_FtUnion, PCD_FtUnion %>% select(-IsProtectedPhase),
  by = c("BinStartTime", "SignalId", "ApproachId"))

df2_FtUnion <- left_join(
  df1_FtUnion, SF_FtUnion %>% select(-IsProtectedPhase),
  by = c("BinStartTime", "SignalId", "ApproachId"))

df3_FtUnion <- left_join(
  df2_FtUnion, PPT_FtUnion, 
  by = c("BinStartTime", "SignalId", "ApproachId"))

df4_FtUnion <- left_join(
  df3_FtUnion, RA_FtUnion %>% select(-IsProtectedPhase),
  by = c("BinStartTime", "SignalId", "ApproachId"))

df5_FtUnion <- left_join(
  df4_FtUnion, Cyc_FtUnion,
  by = c("BinStartTime", "SignalId", "ApproachId"))

df6_FtUnion <- df5_FtUnion %>% 
  mutate(
    TotalTime = as.numeric(TotalTime),
    TotalGreenTime = as.numeric(TotalGreenTime),
    TotalYellowTime = as.numeric(TotalYellowTime),
    TotalRedTime = as.numeric(TotalRedTime),
    PercentGreen = as.numeric(PercentGreen)
  ) %>%
  mutate(
    AMPeak = hour(BinStartTime) >= 7 & hour(BinStartTime) <= 8
  )  %>%
  mutate(
    PercentAOG = (ArrivalsOnGreen + ArrivalsOnYellow) / TotalVolume,
    PercentAOR = ArrivalsOnRed / TotalVolume,
    SFPerCycle = SplitFailures / TotalCycles,
    RAPerCycle = TotalRedLightViolations / TotalCycles
  )

dfAMPeak_FtUnion <- df6_FtUnion %>% 
  filter(df6_FtUnion$AMPeak == "TRUE") %>% 
  write_rds("ATSPM/data/dfAMPeck.rds")

dfMidDay_FtUnion <- df6_FtUnion %>%
  filter(df6_FtUnion$AMPeak == "FALSE") %>% 
  write_rds("ATSPM/data/dfMidDay.rds")

```
