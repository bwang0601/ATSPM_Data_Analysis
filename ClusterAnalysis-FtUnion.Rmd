---
title: "ClusterAnalysis-FtUnion"
author: "Bruce Wang"
date: "11/16/2019"
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r}
library(tidyverse)
```

```{r}
dfAMPeak_FtUnion <- read_rds("data/dfAMPeak_FtUnion.rds")
dfMidDay_FtUnion <- read_rds("data/dfMidDay_FtUnion.rds")
```

## K-means Cluster Analysis
```{r}
# Setup Cluster variables
set.seed(3)

cluster_variables_FtUnion <- c("SplitFailures", "ArrivalsOnGreen", "PlatoonRatio", "TotalRedLightViolations", "PercentForceOffs")

# Create Table without NA Volue
complete_dfAMPeak_FtUnion <- na.omit(dfAMPeak_FtUnion) %>% 
    filter(!ApproachId %in% c(3169, 3172, 5883, 6007, 6042, 6565))


complete_dfMidDay_FtUnion <- na.omit(dfMidDay_FtUnion)  %>% 
    filter(!ApproachId %in% c(3169, 3172, 5883, 6007, 6042, 6565))

# AMPeak Normal and Scaled clusters
clusters_AMPeak_FtUnion <- complete_dfAMPeak_FtUnion %>%
  select(cluster_variables_FtUnion) %>%
  kmeans(centers = 5)

scaled_clusters_AMPeak_FtUnion <- complete_dfAMPeak_FtUnion %>%
  select(cluster_variables_FtUnion) %>%
  mutate_all(scale) %>% # want to scale the data to make it normalized for kmeans
  kmeans(centers = clusters_AMPeak_FtUnion$centers %>% scale() )

clustered_dfAMPeak_FtUnion <- complete_dfAMPeak_FtUnion %>%
  mutate(cluster = clusters_AMPeak_FtUnion$cluster,
         scaled_cluster = scaled_clusters_AMPeak_FtUnion$cluster) %>% 
  write_rds("data/clustered_dfAMPeak_FtUnion.rds")

# MidDay Normal and Scaled clusters
clusters_MidDay_FtUnion <- complete_dfMidDay_FtUnion %>%
  select(cluster_variables_FtUnion) %>%
  kmeans(centers = 5)

scaled_clusters_MidDay_FtUnion <- complete_dfMidDay_FtUnion %>%
  select(cluster_variables_FtUnion) %>%
  mutate_all(scale) %>% # want to scale the data to make it normalized for kmeans
  kmeans(centers = clusters_MidDay_FtUnion$centers %>% scale() )

clustered_dfMidDay_FtUnion <- complete_dfMidDay_FtUnion %>%
  mutate(cluster = clusters_MidDay_FtUnion$cluster,
         scaled_cluster = scaled_clusters_MidDay_FtUnion$cluster) %>% 
  write_rds("data/clustered_dfMidDay_FtUnion.rds")
```
How different are the clusterings? Turns out they are very different!

```{r}
clustered_dfAMPeak_FtUnion %>%
  group_by(cluster, scaled_cluster_AMPeak_FtUnion) %>%
  tally() %>%
  spread(scaled_cluster_AMPeak_FtUnion, n, fill = 0) %>%
  knitr::kable()
```

Going forward, we will make only plots using the scaled clutering algorithm.

## Distributions {.tabset}

We want to try to categorize the clusters based on their values for specific performance measures to see
if the clustering can tell us, for instance, if an intersection is performing well or poorly based on
its cluster assignment alone.

### SplitFailures AMPeak
```{r}
clustered_dfAMPeak_FtUnion %>%
  ggplot(aes(x = SplitFailures)) + geom_bar() + facet_wrap(~scaled_cluster_AMPeak_FtUnion)
```

### SplitFailures MidDay
```{r}
clustered_dfMidDay_FtUnion %>%
  ggplot(aes(x = SplitFailures)) + geom_bar() + facet_wrap(~scaled_cluster_MidDay_FtUnion)
```
Now let's make a table where the percent of cycles ending in split failure by cluster can be plotted.

```{r}
clustered_dfAMPeak_FtUnion %>%
  group_by(scaled_cluster_AMPeak_FtUnion) %>%
  summarize(
    `0` = sum(ifelse(SplitFailures == 0, TRUE, FALSE)) / n(),
    `0- 3` = sum(ifelse(SplitFailures <= 3, TRUE, FALSE)) / n(),
    `> 3` = sum(ifelse(SplitFailures > 3, TRUE, FALSE)) / n()
  )

clustered_dfMidDay_FtUnion %>%
  group_by(scaled_cluster_MidDay_FtUnion) %>%
  summarize(
    `0` = sum(ifelse(SplitFailures == 0, TRUE, FALSE)) / n(),
    `0- 3` = sum(ifelse(SplitFailures <= 3, TRUE, FALSE)) / n(),
    `> 3` = sum(ifelse(SplitFailures > 3, TRUE, FALSE)) / n()
  )

clustered_dfAMPeak_FtUnion %>%
  group_by(scaled_cluster_AMPeak_FtUnion) %>%
  summarize(
    `0` = sum(ifelse(ArrivalsOnRed == 0, TRUE, FALSE)) / n(),
    `1- 3` = sum(ifelse(ArrivalsOnRed< 3, TRUE, FALSE)) / n(),
    `> 4` = sum(ifelse(ArrivalsOnRed > 4, TRUE, FALSE)) / n()
  )
```

## Plots {.tabset}

I wonder if we can code up some kind of discrimination function based on the clusters. Like, 
draw the blue line so it contains 80% of points in cluster 1.

```{r}
# blue_level <- clustered_df %>%
#   filter(scaled_cluster == 1) %>%
#   select(scaled_cluster, ForceOffs) %>%
#   group_by(ForceOffs) %>% tally() %>%
#   mutate(p = n / sum(n),
#          cump = cumsum(p)) %>%
#   filter(cump < 0.85) %>%
#   slice(nrow(.)) %>% .$ForceOffs
# 
# ggplot(clustered_df, aes(x = TotalVolume, y = ForceOffs, color = factor(scaled_cluster))) +
#   geom_abline(slope = 30/200, intercept = 0, col = "red")+
#   geom_abline(slope = 30/400, intercept = -5, col = "red")+
#   geom_abline(slope = 30/600, intercept = -10, col = "red")+
#   geom_abline(slope = 30/800, intercept = -15, col = "red")+
#   geom_hline(yintercept = blue_level, col = "blue")+
#   geom_point(alpha = 0.3) 
# ggplot(clustered_df, aes(x = TotalVolume/TotalCycles, y = ForceOffs/TotalCycles, color = factor(scaled_cluster))) +
#   geom_point(alpha = 0.3)
```

### PlatoonRatio VS PercentAOG AMPeak
```{r}
ggplot(clustered_dfAMPeak_FtUnion, aes(x = PlatoonRatio, y = PercentAOG, color = factor(scaled_cluster_AMPeak_FtUnion))) +
  geom_point(alpha = 0.3) +
  xlim(0,2.5) + ylim(0.00, 1.00) +
  theme_bw()

```

### PlatoonRatio VS PercentAOG MidDay
```{r}
ggplot(clustered_dfMidDay_FtUnion, aes(x = PlatoonRatio, y = PercentAOG, color = factor(scaled_cluster_MidDay_FtUnion))) +
  geom_point(alpha = 0.3) +
  xlim(0,2.5) + ylim(0.00, 1.00) +
  theme_bw()

```

### TotalVolume VS PercentAOG AMPeak
```{r}
ggplot(clustered_dfAMPeak_FtUnion, aes(x = TotalVolume, y =PercentAOG, color = factor(scaled_cluster_AMPeak_FtUnion))) +
  geom_point(alpha = 0.3) +
  xlim(0,850) + ylim(0.00, 1.00) +
  theme_bw()
```

### TotalVolume VS PercentAOG MidDay
```{r}
ggplot(clustered_dfMidDay_FtUnion, aes(x = TotalVolume, y =PercentAOG, color = factor(scaled_cluster_MidDay_FtUnion))) +
  geom_point(alpha = 0.3) + 
  xlim(0,850) + ylim(0.00, 1.00) +
  theme_bw()
```

### TotalVolume VS SplitFailures AMPeak
```{r vol-vs-red-AM}
ggplot(clustered_dfAMPeak_FtUnion, aes(x = TotalVolume/TotalCycles, y = SplitFailures/TotalCycles, color = factor(scaled_cluster_AMPeak_FtUnion))) +
  geom_point(alpha = 0.3) +
  xlim(0,125) + ylim(0.00, 1.00) +
  theme_bw()
```

### TotalVolume VS SplitFailures MidDay
```{r vol-vs-red-MD}
ggplot(clustered_dfMidDay_FtUnion, aes(x = TotalVolume/TotalCycles, y = SplitFailures/TotalCycles, color = factor(scaled_cluster_MidDay_FtUnion))) + 
  geom_point(alpha = 0.3) +
  xlim(0,125) + ylim(0.00, 1.00) +
  theme_bw()
```

### PlatoonRatio VS Split Failures AMPeak
```{r}
ggplot(clustered_dfAMPeak_FtUnion, aes(x = PlatoonRatio, y = SplitFailures/TotalCycles, color = factor(scaled_cluster_AMPeak_FtUnion))) +
  geom_point(alpha = 0.3) +
  xlim(0,2.5) + ylim(0.00, 1.00) +
  theme_bw()
```

### PlatoonRatio VS Split Failures MidDay
```{r}
ggplot(clustered_dfMidDay_FtUnion, aes(x = PlatoonRatio, y = SplitFailures/TotalCycles, color = factor(scaled_cluster_MidDay_FtUnion))) +
  geom_point(alpha = 0.3) + 
  xlim(0,2.5) + ylim(0.00, 1.00) +
  theme_bw()
```

### TotalVolume VS TotalRedLightViolations AMPeak
```{r vol-vs-redlight-AM}
ggplot(clustered_dfAMPeak_FtUnion, aes(x = TotalVolume/TotalCycles, y = TotalRedLightViolations/TotalCycles, color = factor(scaled_cluster_AMPeak_FtUnion))) +
  geom_point(alpha = 0.3) +
  xlim(0, 125) + ylim(0, 5) +
  theme_bw()
```

### TotalVolume VS TotalRedLightViolations MidDay
```{r vol-vs-redlight-MD}
ggplot(clustered_dfMidDay_FtUnion, aes(x = TotalVolume/TotalCycles, y = TotalRedLightViolations/TotalCycles, color = factor(scaled_cluster_MidDay_FtUnion))) +
  geom_point(alpha = 0.3) +
  xlim(0, 125) + ylim(0, 5) +
  theme_bw()
```

### ForceOffs VS Total Volume AMPeak
```{r ForceOffs VS Total Volume-AM}
ggplot(clustered_dfAMPeak_FtUnion, aes(x = TotalVolume/TotalCycles, y = PercentForceOffs, color = factor(scaled_cluster_AMPeak_FtUnion))) +
  geom_point(alpha = 0.3) +
  xlim(0, 125) + ylim(0, 1.5) +
  theme_bw()
```

### ForceOffs VS Total Volume MidDay
```{r ForceOffs VS Total Volume-DM}
ggplot(clustered_dfMidDay_FtUnion, aes(x = TotalVolume/TotalCycles, y = PercentForceOffs, color = factor(scaled_cluster_MidDay_FtUnion))) +
  geom_point(alpha = 0.3) +
  xlim(0, 125) + ylim(0, 1.5) +
  theme_bw()
```
